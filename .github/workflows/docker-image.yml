name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v3
      with:
        node-version: '22' # Replace with your required Node.js version
    - name: Install dependencies and build
      run: |
        npm ci
        npx nx build
    - name: Get version from package.json
      id: get-version
      run: echo "VERSION=$(cat package.json | jq '.version' | tr -d '"')" >> $GITHUB_ENV

    - name: Build the Docker image
      run: |
        docker build . --file Dockerfile --tag ghcr.io/eugeniumegherea/immich-import-control:${VERSION}
        docker push ghcr.io/eugeniumegherea/immich-import-control:${VERSION}
